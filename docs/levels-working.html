<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Levels - C# Gamified Learning</title>
    <link rel="stylesheet" href="assets/css/styles.css">
    <link rel="stylesheet" href="assets/css/prism.css">
    <link rel="manifest" href="manifest.webmanifest">
    <meta name="theme-color" content="#007acc" />
</head>
<body>
    <header>
        <h1>Levels</h1>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="leaderboard.html">Leaderboard</a></li>
                <li><a href="achievements.html">Achievements</a></li>
            </ul>
        </nav>
    </header>
    <main class="container">
        <section class="card">
            <h2>Progress</h2>
            <p id="progress-text">Loading…</p>
            <label for="tier-filter"><strong>Filter by Tier:</strong></label>
            <select id="tier-filter">
                <option value="all">All</option>
                <option value="1">Tier 1 (Essential)</option>
                <option value="2">Tier 2 (Intermediate)</option>
                <option value="3">Tier 3 (Advanced)</option>
            </select>
        </section>

        <section class="card">
            <h2>All Levels</h2>
            <div id="levels-list"></div>
        </section>

        <section class="card" id="level-detail" style="display:none">
            <h2 id="level-title"></h2>
            <p id="level-description"></p>
            <h3>Requirements</h3>
            <ul id="level-requirements"></ul>

            <h3>Theory</h3>
            <div id="level-theory"></div>

            <h3>Example Code</h3>
            <pre><code id="level-code" class="language-csharp"></code></pre>

            <h3>Quick Quiz</h3>
            <div id="quiz-container"></div>
            <button id="submit-quiz" class="button" style="display:none">Submit Answers</button>
            <p id="quiz-result"></p>

            <button id="complete-level" class="button">Mark as completed</button>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 C# Gamified Learning Project</p>
    </footer>
    
    <!-- Load scripts in correct order -->
    <script src="assets/js/storage.js"></script>
    <script src="assets/js/prism.js"></script>
    <script>
        // Embedded levels functionality
        let LevelsData = [];
        const USER_ID = 'local-user';

        async function fetchLevels() {
            try {
                const res = await fetch('data/levels.json');
                const json = await res.json();
                LevelsData = Array.isArray(json.levels) ? json.levels : [];
            } catch (error) {
                console.error('Error fetching levels:', error);
                LevelsData = [];
            }
        }

        function renderProgress() {
            const progressEl = document.getElementById('progress-text');
            if (!progressEl) return;
            const progress = window.LearningStorage?.getUserProgress(USER_ID) || {};
            const completed = (progress.completedLevels || []).length;
            progressEl.textContent = `Completed ${completed}/${LevelsData.length} levels • XP: ${progress.xp || 0}`;
        }

        function renderLevelsList() {
            const list = document.getElementById('levels-list');
            if (!list) return;
            const progress = window.LearningStorage?.getUserProgress(USER_ID) || {};
            const done = new Set(progress.completedLevels || []);
            const tierFilter = document.getElementById('tier-filter');
            const tierValue = tierFilter ? tierFilter.value : 'all';
            list.innerHTML = '';
            
            const filteredLevels = LevelsData.filter(l => tierValue === 'all' || String(l.tier) === String(tierValue));
            filteredLevels.forEach(l => {
                const div = document.createElement('div');
                div.className = 'card';
                const status = done.has(l.id) ? '✅ Completed' : '⏳ Not completed';
                div.innerHTML = `
                    <h3>${l.id.toString().padStart(2,'0')}: ${l.title}</h3>
                    <p>${l.description}</p>
                    <p><strong>Tier:</strong> ${l.tier || 'N/A'}</p>
                    <p><strong>Status:</strong> ${status}</p>
                    <a href="#" class="button" data-level-id="${l.id}">View</a>
                `;
                list.appendChild(div);
            });

            list.querySelectorAll('a[data-level-id]').forEach(a => {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    const id = parseInt(a.getAttribute('data-level-id'));
                    showLevelDetail(id);
                });
            });
        }

        function showLevelDetail(levelId) {
            const level = LevelsData.find(l => l.id === levelId);
            if (!level) return;
            
            document.getElementById('level-title').textContent = `${level.id.toString().padStart(2,'0')}: ${level.title}`;
            document.getElementById('level-description').textContent = level.description;
            
            const req = document.getElementById('level-requirements');
            req.innerHTML = '';
            (level.requirements || []).forEach(r => {
                const li = document.createElement('li');
                li.textContent = r;
                req.appendChild(li);
            });
            
            // Theory
            const theory = document.getElementById('level-theory');
            theory.innerHTML = level.theory || '—';
            
            // Code with syntax highlighting
            const code = document.getElementById('level-code');
            code.textContent = level.code || '';
            if (window.Prism && level.code) {
                Prism.highlightElement(code);
            }
            
            // Simple quiz rendering
            renderQuiz(level);
            
            const btn = document.getElementById('complete-level');
            btn.onclick = () => {
                window.LearningStorage?.completeLevel(USER_ID, level.id);
                window.LearningStorage?.addXp(USER_ID, 10);
                alert(`Great job! Marked "${level.title}" as completed and awarded 10 XP.`);
                renderProgress();
                renderLevelsList();
            };
            
            document.getElementById('level-detail').style.display = '';
            window.scrollTo({ top: document.getElementById('level-detail').offsetTop, behavior: 'smooth' });
        }

        function renderQuiz(level) {
            const container = document.getElementById('quiz-container');
            const submitBtn = document.getElementById('submit-quiz');
            const resultEl = document.getElementById('quiz-result');
            container.innerHTML = '';
            resultEl.textContent = '';
            
            if (!Array.isArray(level.quiz) || level.quiz.length === 0) {
                submitBtn.style.display = 'none';
                return;
            }
            
            submitBtn.style.display = '';
            level.quiz.forEach((q, qi) => {
                const block = document.createElement('div');
                block.className = 'card';
                const isMulti = !!q.multi;
                const name = `q_${qi}`;
                const options = q.options.map((opt, oi) => {
                    const type = isMulti ? 'checkbox' : 'radio';
                    return `<label><input type="${type}" name="${name}" value="${oi}"> ${opt}</label>`;
                }).join('<br>');
                block.innerHTML = `<p><strong>Q${qi+1}:</strong> ${q.q}</p>${options}`;
                container.appendChild(block);
            });
            
            submitBtn.onclick = () => {
                let correct = 0;
                level.quiz.forEach((q, qi) => {
                    const chosen = Array.from(document.querySelectorAll(`input[name="q_${qi}"]:checked`)).map(i => parseInt(i.value));
                    const expected = Array.isArray(q.answer) ? q.answer.map(n => parseInt(n)) : [parseInt(q.answer)];
                    chosen.sort(); expected.sort();
                    if (JSON.stringify(chosen) === JSON.stringify(expected)) correct++;
                });
                const score = Math.round((correct / level.quiz.length) * 100);
                resultEl.textContent = `Score: ${score}% (${correct}/${level.quiz.length})`;
                if (score >= 80) {
                    window.LearningStorage?.addXp(USER_ID, 10);
                }
                renderProgress();
            };
        }

        async function initLevelsPage() {
            await fetchLevels();
            const tierFilter = document.getElementById('tier-filter');
            if (tierFilter) {
                tierFilter.addEventListener('change', () => renderLevelsList());
            }
            renderProgress();
            renderLevelsList();
        }

        // Initialize when DOM is ready
        document.addEventListener('DOMContentLoaded', initLevelsPage);
    </script>
    
    <script src="assets/js/app.js"></script>
    <script src="assets/js/achievements.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js');
            });
        }
    </script>
</body>
</html>
